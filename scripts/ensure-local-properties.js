#!/usr/bin/env node
/**
 * Ensures that android/local.properties exists with a valid sdk.dir.
 * Priority:
 *  1. ANDROID_SDK_ROOT env
 *  2. ANDROID_HOME env
 *  3. Default platform path (macOS: ~/Library/Android/sdk, Linux: $HOME/Android/Sdk)
 */
const fs = require('fs');
const path = require('path');
const os = require('os');

const androidDir = path.join(__dirname, '..', 'android');
const localPropsPath = path.join(androidDir, 'local.properties');

function detectSdkDir() {
  const envDir = process.env.ANDROID_SDK_ROOT || process.env.ANDROID_HOME;
  if (envDir) return envDir;
  const home = os.homedir();
  const candidates = [
    path.join(home, 'Library', 'Android', 'sdk'),
    path.join(home, 'Android', 'Sdk'),
  ];
  for (const c of candidates) {
    if (fs.existsSync(c)) return c;
  }
  return candidates[0];
}

function main() {
  const sdkDir = detectSdkDir();
  const contents = `## Automatically generated by scripts/ensure-local-properties.js\n## Edit this file if the detected path is wrong.\nsdk.dir=${sdkDir.replace(/\\/g, '/')}\n`;

  if (fs.existsSync(localPropsPath)) {
    const existing = fs.readFileSync(localPropsPath, 'utf8');
    if (/sdk\.dir=/.test(existing)) {
      console.log('[ensure-local-properties] Already present ->', existing.split('\n').find(l => l.startsWith('sdk.dir=')));
      return;
    }
  }
  fs.writeFileSync(localPropsPath, contents, 'utf8');
  console.log('[ensure-local-properties] Wrote android/local.properties with sdk.dir =', sdkDir);
}

main();
